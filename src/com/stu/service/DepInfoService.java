package com.stu.service;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

import com.stu.bean.Depinfo;
import com.stu.bean.Paging;
import com.stu.dbconn.DBConnection;
import com.stu.untils.CheckStr;
/**
 * 
 * ????????StuManager
 * ???????DepInfoService 
 * ???????? ???????????
 * ???????kk
 * ???????2018??12??21?? ????8:15:52
 * ??????kk
 * ??????2018??12??21?? ????8:15:52
 * ???????: xx???
 * ??????? 
 * ?·Ú??: V1.0
 * ????: 2018??12??21??
 */
public class DepInfoService extends DBConnection{
	private int result=0;
	/**
	 * ????????
	* @Title: selectDepInfoList 
	* @Description: TODO(????????Ñö?????????????????) 
	* @param @param deps
	* @param @return    ?Ú…??? 
	* @return List<Depinfo>    ????????  ???????????(???)
	* @throws
	 */
	public List<Depinfo> selectDepInfoList(Depinfo deps,Paging page){
		//?????????????
		List<Depinfo> depList=new ArrayList<Depinfo>();
		//?????????????
		conn=getDBconn();
		
		StringBuffer sb=new StringBuffer();
		//???SQL???
		sb.append("select d.*," + 
				"(select count(*) from specilinfo p where p.depinfoid=d.depinfoid) spnum," + 
				"(SELECT COUNT(*) FROM specilinfo a JOIN classinfo b ON a.spilinfoId=b.spilinfoId WHERE a.depinfoid=d.depinfoid) classnum" + 
				" from depinfo d where 1=1 ");
		//????????????????????
		if(CheckStr.isEmpty(deps.getDepinfoname())) {
			sb.append(" and depinfoname like '%"+deps.getDepinfoname()+"%'");
		}
		//??????ID??????????
		if(CheckStr.isEmpty(deps.getDepinfoId())) {
			sb.append(" and depinfoid="+deps.getDepinfoId());
		}
		if(page!=null) {
			sb.append(" limit ?,?");
		}
		try {
			//???????????
			pst=conn.prepareStatement(sb.toString());
			if (page!=null) {
				pst.setInt(1, (page.getPage()-1)*page.getPagesize());
				pst.setInt(2,page.getPagesize());
			}
			//??§Ó?????
			rs=pst.executeQuery();
			while(rs.next()) {
				Depinfo dep=new Depinfo();
				dep.setDepinfoId(rs.getInt(1)+"");
				dep.setDepInfoCode(rs.getString(2));
				dep.setDepinfoname(rs.getString(3));
				dep.setDepinfoPreOfTech(rs.getInt(4)+"");
				dep.setDepinfoAssTeach(rs.getInt(5)+"");
				dep.setSpnum(rs.getInt(6)+"");
				dep.setClassnum(rs.getInt(7)+"");
				//????????? ??????????????????
				depList.add(dep);
			}
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}finally {
			//????????????
			super.closeConn();
		}
		return depList;
	}
	public int selectDepInfoListCount(Depinfo deps){
		//?????????????
		conn=getDBconn();
		int flag=0;
		StringBuffer sb=new StringBuffer();
		//???SQL???
		sb.append("SELECT COUNT(*) FROM depinfo WHERE 1=1 ");
		//????????????????????
		if(CheckStr.isEmpty(deps.getDepinfoname())) {
			sb.append(" and depinfoname like '%"+deps.getDepinfoname()+"%'");
		}
		//??????ID??????????
		if(CheckStr.isEmpty(deps.getDepinfoId())) {
			sb.append(" and depinfoid="+deps.getDepinfoId());
		}
		
		try {
			//???????????
			pst=conn.prepareStatement(sb.toString());
		
			//??§Ó?????
			rs=pst.executeQuery();
			if(rs.next()) {
				flag=rs.getInt(1);
			}
				
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}finally {
			//????????????
			super.closeConn();
		}
		return flag;
	}
	/**
	 * ?????
	* @Title: addDepInfo 
	* @Description: TODO(????????Ñö?????????????????) 
	* @param @param dep
	* @param @return    ?Ú…??? 
	* @return int    ????????    ????0????????????????
	* @throws
	 */
	public int addDepInfo(Depinfo dep) {
		//?????????????
		conn=getDBconn();
		String ins="insert into depinfo(depinfocode,depinfoname,depinfopreoftech,depinfoassteach) values(?,?,?,?)";
		try {
			//???????????
			 pst=conn.prepareStatement(ins);
			//?????¦Ë??
			pst.setString(1, dep.getDepInfoCode());
			pst.setString(2,dep.getDepinfoname());
			pst.setString(3, dep.getDepinfoPreOfTech());
			pst.setString(4,  dep.getDepinfoAssTeach());
			//???SQL???
			result=pst.executeUpdate();
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}finally {
			//????????????
			super.closeConn();
		}
		return result;
	}
	/**
	 * ?????
	* @Title: updateDep 
	* @Description: TODO(????????Ñö?????????????????) 
	* @param @param dep
	* @param @return    ?Ú…??? 
	* @return int   ????????   ????0?????????????????
	* @throws
	 */
	public int updateDep(Depinfo dep) {
		//?????????????
		conn=getDBconn();
		//???SQL???
		String upd="update depinfo set depinfoname=?,depinfopreoftech=?,depinfoassteach=?"+
		"where depinfoid=?";
		try {
			//???????????
			pst=conn.prepareStatement(upd);
			//?????¦Ë??
			pst.setString(1, dep.getDepinfoname());
			pst.setString(2, dep.getDepinfoPreOfTech());
			pst.setString(3,  dep.getDepinfoAssTeach());
			pst.setInt(4,Integer.parseInt(dep.getDepinfoId()));
			//?????????
			result=pst.executeUpdate();
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}finally {
			//????????????
			super.closeConn();
		}
		return result;
	}
	/**
	 * ????????
	* @Title: detDep 
	* @Description: TODO(????????Ñö?????????????????) 
	* @param @param depId
	* @param @return    ?Ú…??? 
	* @return int    ????????  ????0?????????????????
	* @throws
	 */
	public int detDep(String depId) {
		//?????????????
		conn=getDBconn();
		//???SQL???
		String del="delete from depinfo where depinfoid=?";
		try {
			//???????????
			PreparedStatement ps=conn.prepareStatement(del);
			//?????¦Ë??
			ps.setInt(1, Integer.parseInt(depId));
			//???SQL???
			result=ps.executeUpdate();
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}finally {
			//????????????
			super.closeConn();
		}
		
		return result;
	}
	/**
	 * ????????????
	* @Title: doAjaxCKCode 
	* @Description: TODO(????????Ñö?????????????????) 
	* @param @param code
	* @param @return    ?Ú…??? 
	* @return int    ????????   ????1???????????0??????????
	* @throws
	 */
	public int doAjaxCKCode(String code) {
		int b=0;
		//?????????????
		conn=getDBconn();
		//???SQL???
		StringBuffer sb=new StringBuffer();
		sb.append(" select * from depinfo where depinfocode=?");
		//???????????
		try {
			pst=conn.prepareStatement(sb.toString());
			//?????¦Ë??
			pst.setString(1, code);
			//??§Ó?????
			rs=pst.executeQuery();
			if(rs.next()) {
				b=1;
			}
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}finally {
			super.closeConn();
		}
		return b;
	}
}
